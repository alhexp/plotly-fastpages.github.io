name: Setup
on: push

permissions:
  actions: write
  pull-requests: write
  contents: write
  deployments: write
  pages: write
  statuses: write

jobs:
  setup:
    if: (github.event.commits[0].message == 'Initial commit') && (github.run_number == 1)
    runs-on: ubuntu-latest
    steps:
      - name: Check out
        uses: actions/checkout@v2
      
      - name: Set up Node.js      
        uses: actions/setup-node@v2
        with:
          node-version: '16.x'

      - name: Copy Repository Contents
        uses: actions/checkout@v2

      - name: modify files
        run: |
          import re, os
          from pathlib import Path
          from configparser import ConfigParser
          config = ConfigParser()
          nwo = os.getenv('GITHUB_REPOSITORY')
          username, repo_name = nwo.split('/')
          readme_template_path = Path('_fastpages_docs/README_TEMPLATE.md')
          readme_path = Path('README.md')
          config_path = Path('_config.yml')
          pr_msg_path = Path('_fastpages_docs/_setup_pr_template.md')
          settings = Path('_action_files/settings.ini')
          assert readme_template_path.exists(), 'Did not find _fastpages_docs/README_TEMPLATE.md in the current directory!'
          assert readme_path.exists(), 'Did not find README.md in the current directory!'
          assert config_path.exists(), 'Did not find _config.yml in the current directory!'
          assert pr_msg_path.exists(), 'Did not find _fastpages_docs/_setup_pr_template.md in the current directory!'
          assert settings.exists(), 'Did not find _action_files/settings.ini in the current directory!'
          # edit settings.ini file to inject baseurl
          config.read(settings)
          config['DEFAULT']['baseurl'] = f'/{repo_name}'
          with open('_action_files/settings.ini', 'w') as configfile:
            config.write(configfile)
          # replace content of README with template
          readme = readme_template_path.read_text().replace('{_username_}', username).replace('{_repo_name_}', repo_name)
          readme_path.write_text(readme)
          # update _config.yml
          cfg = config_path.read_text()
          cfg = re.sub(r'^(github_username: )(fastai)', fr'\g<1>{username}', cfg, flags=re.MULTILINE)
          cfg = re.sub(r'^(baseurl: )("")', r'\1"/{}"'.format(repo_name), cfg, flags=re.MULTILINE)
          cfg = re.sub(r'^(github_repo: ")(fastpages)', r'\1{}'.format(repo_name), cfg, flags=re.MULTILINE)
          cfg = re.sub(r'^(url: "https://)(fastpages.fast.ai)("

